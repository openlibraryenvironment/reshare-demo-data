<?xml version="1.0" encoding="UTF-8"?>
<xsl:stylesheet
  version="1.0"
  xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
  xmlns:marc="http://www.loc.gov/MARC21/slim"
  xmlns:oai20="http://www.openarchives.org/OAI/2.0/"
  >

  <xsl:strip-space elements="*"/>
  <xsl:output indent="yes" method="xml" version="1.0" encoding="UTF-8"/>

  <xsl:template match="collection">
    <collection>
        <xsl:apply-templates/>
    </collection>
  </xsl:template>

  <xsl:template match="record">
    <record>
        <xsl:for-each select="@* | node()">
            <xsl:copy-of select="."/>
        </xsl:for-each>
        <xsl:apply-templates/>
    </record>
  </xsl:template>

  <xsl:variable name="WILL_LEND">46970b40-918e-47a4-a45d-b1677a2d3d46</xsl:variable> <!-- FOLIO Inventory ILL Policy value 'Will lend' -->
  <xsl:variable name="WILL_NOT_LEND">b0f97013-87f5-4bab-87f2-ac4a5191b489</xsl:variable> <!-- FOLIO Inventory ILL Policy value 'Will not lend' -->

  <xsl:variable name="CNTYPE_DEWEY">03dd64d0-5626-4ecd-8ece-4531e0069f35</xsl:variable> <!-- Call number type: Dewey Decimal Classification  -->
  <xsl:variable name="CNTYPE_LOC">95467209-6d7b-468b-94df-0f5d7ad2747d</xsl:variable> <!-- Call number type: LOC  -->
  <xsl:variable name="CNTYPE_OTHER">6caca63e-5651-4db6-9247-3205156e9699</xsl:variable> <!-- Call number type: Other (catch unmapped)  -->
  <xsl:variable name="CNTYPE_SUDOC">fc388041-6cd0-4806-8a74-ebe3b9ab4c6e</xsl:variable> <!-- Call number type: Other (catch unmapped)  -->

  <xsl:template match="//marc:record">
    <holdingsRecords>
      <arr>
        <xsl:for-each select="marc:datafield[@tag='945']">
          <xsl:sort select="./marc:subfield[@code='l']"/>
          <xsl:variable name="preloc">
            <xsl:value-of select="./preceding-sibling::marc:datafield[@tag='945'][1]/marc:subfield[@code='l']"/>
          </xsl:variable>
          <xsl:variable name="iid" select="./marc:subfield[@code='y']"/>
          <xsl:variable name="loc" select="./marc:subfield[@code='l']"/>
          <xsl:if test="not($loc=$preloc)">
            <i>
              <xsl:variable name="loc-clean" select="normalize-space($loc)"/>
              <permanentLocationIdHere><xsl:value-of select="$loc-clean"/></permanentLocationIdHere>
              <illPolicyId>
              </illPolicyId>
              <callNumber><xsl:value-of select="./marc:subfield[@code='a']"/></callNumber>
            </i>
          </xsl:if>
        </xsl:for-each>
      </arr> 
     </holdingsRecords>
  </xsl:template>
  <xsl:template match="text()"/>
</xsl:stylesheet>
